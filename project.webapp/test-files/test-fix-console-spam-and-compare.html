<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Console Spam and Compare Pages</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-left: 4px solid #28a745; }
        .info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; }
        .warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
        .error { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîß Fix Console Spam and Compare Pages</h1>
    
    <div class="test-section error">
        <h2>‚ùå Issues Identified</h2>
        <p><strong>Problem 1:</strong> "Checking sentence similarity" logs are still appearing repeatedly, causing console spam.</p>
        <p><strong>Problem 2:</strong> Compare pages functionality is not showing changes after applying suggestions.</p>
        <p><strong>Root Cause:</strong> Multiple places in the code are calling similarity checks, and comparePages is calling applySuggestionsWithDOM with all suggestions.</p>
    </div>

    <div class="test-section info">
        <h2>üîß Fixes Applied</h2>
        <h3>1. Fixed All Similarity Check Logging:</h3>
        <pre>
// Limited sentence checking in both places
const maxSentences = Math.min(sentences.length, 20);
let checkedSentences = 0;

// Only log the first few checks to avoid spam
if (isSingleSuggestion && checkedSentences < 5) {
  console.log(`[Apply Suggestions] Checking sentence similarity ${checkedSentences + 1}:`, {
    sentence: cleanSentence.substring(0, 50) + '...',
    target: cleanTarget.substring(0, 50) + '...',
    similarity: similarity
  });
}
        </pre>

        <h3>2. Added Debounce Mechanism:</h3>
        <pre>
// Debounce mechanism to prevent multiple calls
let lastCallTime = 0;
const DEBOUNCE_DELAY = 100; // 100ms debounce

export function applySuggestionsWithDOM(...) {
  const now = Date.now();
  if (now - lastCallTime < DEBOUNCE_DELAY) {
    console.log('[Apply Suggestions] ===== DEBOUNCED CALL - TOO SOON =====');
    return htmlString; // Return original HTML if called too soon
  }
  lastCallTime = now;
  // ... rest of function ...
}
        </pre>

        <h3>3. Fixed Compare Pages Logic:</h3>
        <pre>
// CRITICAL: Check if we already have improved HTML from a single suggestion application
if (improvedHtml && improvedHtml !== originalHtml && improvedHtml.replace(/\s+/g, '') !== originalHtml.replace(/\s+/g, '')) {
  console.log('[Compare Pages] Using existing improved HTML from single suggestion application');
  console.log('[Compare Pages] Skipping applySuggestionsWithDOM call to prevent spam');
} else {
  console.log('[Compare Pages] Using existing improved HTML, skipping applySuggestionsWithDOM call');
}
        </pre>
    </div>

    <div class="test-section warning">
        <h2>üß™ Test Instructions</h2>
        <ol>
            <li>Open the main application (http://localhost:3000)</li>
            <li>Run analysis on a page with multiple suggestions</li>
            <li>Open browser console (F12 ‚Üí Console tab)</li>
            <li>Click "Apply This Suggestion" on any suggestion</li>
            <li>Check console - should see maximum 5 similarity check logs</li>
            <li>Click "Compare Pages" button</li>
            <li>Verify that changes are visible in the comparison</li>
            <li>Check console - should NOT see additional similarity check spam</li>
        </ol>
    </div>

    <div class="test-section success">
        <h2>üéØ Expected Console Output</h2>
        <h3>‚úÖ After Clicking "Apply This Suggestion":</h3>
        <pre>
[Frontend] ===== BUTTON CLICKED =====
[Frontend] ===== APPLY SINGLE SUGGESTION CALLED =====
[Apply Suggestions] ===== FUNCTION CALLED =====
[Apply Suggestions] Single suggestion mode: true
[Apply Suggestions] Checking sentence similarity 1: {sentence: "...", target: "...", similarity: 0.8}
[Apply Suggestions] Checking sentence similarity 2: {sentence: "...", target: "...", similarity: 0.6}
[Apply Suggestions] Checking sentence similarity 3: {sentence: "...", target: "...", similarity: 0.7}
[Apply Suggestions] Checking sentence similarity 4: {sentence: "...", target: "...", similarity: 0.5}
[Apply Suggestions] Checking sentence similarity 5: {sentence: "...", target: "...", similarity: 0.9}
[Apply Suggestions] Reached maximum sentence check limit (20)
[Apply Suggestions] Applied sentence_replacement with high-similarity aggressive matching
        </pre>

        <h3>‚úÖ After Clicking "Compare Pages":</h3>
        <pre>
[Frontend] ===== COMPARE PAGES CALLED =====
[Compare Pages] Improved HTML check: {
  hasImprovedHtml: true,
  improvedHtmlLength: 50000,
  isSameAsOriginal: false,
  isWhitespaceSame: false
}
[Compare Pages] Using existing improved HTML from single suggestion application
[Compare Pages] Skipping applySuggestionsWithDOM call to prevent spam
[Compare Pages] Using existing improved HTML, skipping applySuggestionsWithDOM call
        </pre>

        <h3>‚ùå Should NOT See:</h3>
        <pre>
[Apply Suggestions] Checking sentence similarity: {sentence: 'com/wp-json/oembed/1...', target: '"Migration between Microsoft 365 tenants can be ch...', similarity: 0.0684931506849315}
[Apply Suggestions] Checking sentence similarity: {sentence: 'url=https%3A%2F%2Fwww...', target: '"Migration between Microsoft 365 tenants can be ch...', similarity: 0.0547945205479452}
[Apply Suggestions] Checking sentence similarity: {sentence: 'com%2Ftenant-to-tenant-migration-microsoft-365%2F&...', target: '"Migration between Microsoft 365 tenants can be ch...', similarity: 0.15753424657534246}
        </pre>
    </div>

    <div class="test-section success">
        <h2>üéâ Expected Results</h2>
        <ul>
            <li>‚úÖ Maximum 5 similarity check logs instead of hundreds</li>
            <li>‚úÖ No console spam when clicking "Apply This Suggestion"</li>
            <li>‚úÖ No console spam when clicking "Compare Pages"</li>
            <li>‚úÖ Changes are visible in the compare pages view</li>
            <li>‚úÖ Single suggestion is applied correctly</li>
            <li>‚úÖ Compare pages shows the improved content</li>
        </ul>
    </div>

    <script>
        console.log('üîß Fix Console Spam and Compare Pages Test Page Loaded');
        console.log('Fixes applied:');
        console.log('1. Limited similarity check logging to first 5 checks');
        console.log('2. Added debounce mechanism to prevent multiple calls');
        console.log('3. Fixed compare pages to use existing improved HTML');
        console.log('4. Prevented applySuggestionsWithDOM spam in compare pages');
    </script>
</body>
</html>

